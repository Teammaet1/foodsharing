<!DOCTYPE html>

  <head>
    <meta charset="utf-8" />
    <link rel="shortcut icon" href="%PUBLIC_URL%/favicon.ico" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <meta name="theme-color" content="#000000" />
    <!--
      manifest.json provides metadata used when your web app is installed on a
      user's mobile device or desktop. See https://developers.google.com/web/fundamentals/web-app-manifest/
    -->
    <link rel="manifest" href="%PUBLIC_URL%/manifest.json" />
    <!--
      Notice the use of %PUBLIC_URL% in the tags above.
      It will be replaced with the URL of the `public` folder during the build.
      Only files inside the `public` folder can be referenced from the HTML.

      Unlike "/favicon.ico" or "favicon.ico", "%PUBLIC_URL%/favicon.ico" will
      work correctly both with client-side routing and a non-root public URL.
      Learn how to configure a non-root public URL by running `npm run build`.
    -->
<link href="../css/layout.css" rel="stylesheet" type="text/css" media="all">
    <title>Calling an API</title>
  </head>

<!--ФОН-->
<body style="background-image: url('../images/demo/backgrounds/1.jpg'); min-height: 100vh; max-height: auto; background-repeat: no-repeat; background-size: cover; background-position: center center; color: black; text-align: center; display: flex; flex-direction: column; justify-content: space-between; ">
<!--ФОН-->

<!--МЕНЮ-->
<div style="align-items: center"class="wrapper row2">
  <nav id="mainav" class="hoc clear">
    <!-- ################################################################################################ -->
    <ul class="clear">
      <li><a href="../index.html">Главная</a></li>
      <li><a href="to-volonteers.html">Участникам</a></li>
      <li><a href="sidebar-right.html">Sidebar Right</a></li>
      <li><a href="volonterstvo.html">Волонтерство</a></li>
      <li><a href="FAQ.html">Справка</a></li>
      <li class="active"><a href="autorization.html">Авторизация</a></li>
    </ul>
  </nav>
</div>

<div class="wrapper bgded" >
  <div id="pageintro" class="hoc clear">
</div>
<!--АВТОРИЗАЦИЯ-->
<div style="margin-bottom: 220px; align-items: center; display: flex;" class="wrapper row3">
  <main class="hoc container clear">
    <header class="header">

    <h1 class="header__title">
    Авторизация
    </h1>

    <ul id="menu" class="menu">
    </ul>

    <div id="errors" ></div>
        <form name="userForm" class="authorize__panel">
            <div class="user__div">
                <label class="label__user"  for="email">Email:</label>
                <input class="input__user" placeholder="Email" name="email" />
            </div>
            <div class="user__div">
                <label class="label__user"  for="password">Password:</label>
                <input class="input__user" placeholder="Password"  name="password" type="password" />
            </div>
            <div >
                <button class="user__button" type="submit" id="submit">Войти</button>
            </div>
        </form>
    </header>

    <div class="clear"></div>
  </main>
</div>
<!--АВТОРИЗАЦИЯ-->
<a id="backtotop" href="#top"><i class="fa fa-chevron-up"></i></a>
<script>

        var referrer_url = document.referrer; //Заносим в переменную прошлую ссылку
        async function Login(userEmail, userPassword, rememberMe) { //Функция входа в аккаунт

            const response = await fetch("https://localhost:7285/Account/Login", {
                method: "POST",
                headers: { "Accept": "application/json", "Content-Type": "application/json"},
                body: JSON.stringify({ // в json отправляем майл пароль и статическую переменную не запоминать акканут(так как еще не работает запоминание)
                    email: userEmail,
                    password: userPassword,
                    rememberme: false 
                })
            });
            if (response.ok === true) {
                const a = document.createElement('a');//Если вешел до делаем переход в прошлую ссылку    //TODO:проверка ссылки
                a.setAttribute('href', referrer_url);
                a.click();
            }
            else { //Если не вошел показываем ошибку
                const errorData = await response.json();
                document.getElementById("errors").innerHTML = '';
                if (errorData.errors) {
                    if (errorData.errors["Email"]) { //Если проблема в майле то показываем ошибку с майлом
                        addError(errorData.errors["Email"]);
                    }
                    if (errorData.errors["Password"]) {
                        addError(errorData.errors["Password"]);
                    }
                }
                if (errorData) {
                    if (errorData["Email"]) {
                        addError(errorData["Email"]);
                    }

                }

                document.getElementById("errors").style.display = "block"; //Делаем строку ошибки видимой
            }
        }

        function addError(errors) {//Функция для добавление в строку ошибки описание ошибки

            errors.forEach(error => { //Через цикл, так как ошибок может быть несколько
                const p = document.createElement("p");
                p.append(error);

                document.getElementById("errors").append(p);  //Находим строку для ошибок и добавляем описание
            });
        }



        document.forms["userForm"].addEventListener("submit", e => { //Создаем ивень при нажатие на кнопку с id submit 
            e.preventDefault();
            const form = document.forms["userForm"]; //Находим форму userForm 
            const email = form.elements["email"].value; //В эту форму находим элемент email и значение в этом элементе заносим в переменную
            const password = form.elements["password"].value; //В эту форму находим элемент password и значение в этом элементе заносим в переменную

            Login(email, password, true); //Вызываем функцию для авторизации и передаем переменные

        });




        //async function GetAuthorize() { //Функция для настройки менюшки начальной
        //    const response = await fetch("/", {
        //        method: "GET",
        //        headers: { "Accept": "application/json"},
        //    });
        //    if (response.ok === true) {
        //        window.location.href = '/index.html';
        //    }


        //    let rows = document.getElementById("menu");
        //    let liMain = document.createElement("li");
        //    liMain.setAttribute("class", "menu__item");
        //    let mainA = document.createElement("a");
        //    mainA.append("Главная");
        //    mainA.setAttribute("href", "/index.html")
        //    mainA.setAttribute("class", "menu__link link__outside link__animation");
        //    liMain.append(mainA);
        //    rows.append(liMain);

        //    let liAuthorize = document.createElement("li");
        //    liAuthorize.setAttribute("class", "menu__item");
        //    let authorizeA = document.createElement("a");
        //    authorizeA.append("Авторизация");
        //    authorizeA.setAttribute("href", "#")
        //    authorizeA.setAttribute("class", "menu__link link__inside");
        //    liAuthorize.append(authorizeA);
        //    rows.append(liAuthorize);

        //    let liFAQ = document.createElement("li");
        //    liFAQ.setAttribute("class", "menu__item");
        //    let FAQa = document.createElement("a");
        //    FAQa.append("FAQ");
        //    FAQa.setAttribute("href", "#")
        //    FAQa.setAttribute("class", "menu__link link__outside link__animation");
        //    liFAQ.append(FAQa);
        //    rows.append(liFAQ);

        //}

        //GetAuthorize();
    </script>


<!-- JAVASCRIPTS -->
<script src="layout/scripts/jquery.min.js"></script>
<script src="layout/scripts/jquery.backtotop.js"></script>
<script src="layout/scripts/jquery.mobilemenu.js"></script>
<!-- IE9 Placeholder Support -->
<script src="layout/scripts/jquery.placeholder.min.js"></script>
<!-- / IE9 Placeholder Support -->
</body>
</html>
