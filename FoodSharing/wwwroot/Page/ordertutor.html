<!DOCTYPE html>

<head>
<title>Foodsharing</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link href="../css/layout.css" rel="stylesheet" type="text/css" media="all">
</head>
<body style="background-image: url('../images/demo/backgrounds/1.jpg'); min-height: 100vh; max-height: auto; background-repeat: no-repeat; background-size: cover; background-position: center center; color: black; text-align: center; display: flex; flex-direction: column; justify-content: space-between; ">

<div style="align-items: center"class="wrapper row2">
  <nav id="mainav" class="hoc clear">
    <!-- ################################################################################################ -->
    <ul class="clear">
      <li><a href="../index.html">Главная</a></li>
      <li><a href="to-volonteers.html">Участникам</a></li>
      <li><a href="sidebar-right.html">Sidebar Right</a></li>
      <li ><a href="volonterstvo.html">Волонтерство</a></li>
      <li><a href="FAQ.html">Справка</a></li>
      <li class="active"><a href="../Page/tutor-lk.html">Личный кабинет</a></li>
    </ul>
  </nav>
</div>


<div class="wrapper bgded" >
  <div id="pageintro" class="hoc clear">
</div>

<div style="margin-bottom: 280px;" class="wrapper row3">
  <main class="hoc container clear">
      <div class="center btmspace-50">
          <h2 class="heading">Заказ</h2>

          <h3 id="shop"></h3>

          <table id="productItem">
          </table>



          <form>
              <center>
                  <p>
                      <select id="select" name="select" multiple>
                      </select>
                      <input id="submit" type="submit" value="Отправить">
                  </p>
              </center>
          </form>
      </div>

    <div class="clear"></div>
  </main>
</div>

<script>
    async function GetOrder(id) {
        const response = await fetch("/order/OrderTutor/" + id, {
            method: "GET",
            headers: { "Accept": "application/json" }
        });
        if (response.ok === true) {
            const order = await response.json();
            let table = document.getElementById("productItem");
            let shop = document.getElementById("shop");
            shop.append(order.shop.chain.name + " " + order.shop.address)
            order.products.forEach(product => {
                const tr = document.createElement("tr");
                tr.append(product.name);
                table.append(tr);
            })
        }
    }

    async function GetVolontes() {
        const response = await fetch("https://localhost:7285/user/volonters", {
            method: "GET",
            headers: { "Accept": "application/json" }
        });
        if (response.ok === true) {
            const volonters = await response.json();
            let select = document.getElementById("select");
            volonters.forEach(volonter => {
                const option = document.createElement("option");
                option.append(volonter.fio);
                option.setAttribute('value', volonter.id)
                select.append(option);
            })
        }
    }

    async function Authorize() {
        const response = await fetch("https://localhost:7285/Account/Authorize", {
            method: "GET",
            headers: { "Accept": "application/json" }
        });
        if (response.ok === false) {
            window.location.href = '/index.html';
        }
        else
            Role();
    }
    async function SendVolonter(idOrder, idVolonter) {
        const response = await fetch("/order/sendVolonter", {
            method: "POST",
            headers: { "Accept": "application/json", "Content-Type": "application/json" },
            body: JSON.stringify({ 
                idOrder: idOrder,
                idVolonter: idVolonter
            })
        });
        if (response.ok === true) {
            window.location.href = '/shoporders.html';
        }
    }

    async function Role() {
        const response = await fetch("https://localhost:7285/Account/AuthorizeRole", {
            method: "GET",
            headers: { "Accept": "application/json" }
        });
        if (response.ok === true) {
            const resStr = await response.json();
            let exit = true
            resStr.forEach(str => {
                if (str === "tutor")
                    exit = false;
            })
            if (exit)
                window.location.href = '/index.html';
        }

    }

    document.getElementById("submit").addEventListener("click", e => {
        e.preventDefault();
        var idVolonter = document.getElementById("select");
        SendVolonter(id, idVolonter.value);
    });

    Authorize();
    var id = window.location.href.split("?")[1].split("=")[1];
    GetOrder(id);
    GetVolontes();
</script>
</body>
</html>
