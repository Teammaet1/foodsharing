<!DOCTYPE html>

<head>
<title>Foodsharing</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link href="../css/layout.css" rel="stylesheet" type="text/css" media="all">
</head>
<body style="background-image: url('../images/demo/backgrounds/1.jpg'); min-height: 100vh; max-height: auto; background-repeat: no-repeat; background-size: cover; background-position: center center; color: black; text-align: center; display: flex; flex-direction: column; justify-content: space-between; ">

<div style="align-items: center"class="wrapper row2">
  <nav id="mainav" class="hoc clear">
    <!-- ################################################################################################ -->
    <ul class="clear">
      <li><a href="../index.html">Главная</a></li>
      <li><a >Участникам</a></li>
      <li><a >Sidebar Right</a></li>
      <li ><a >Волонтерство</a></li>
      <li><a >Справка</a></li>
      <li class="active"><a id="authorize" href="../Page/tutor-lk.html">Личный кабинет</a></li>
    </ul>
  </nav>
</div>


<div class="wrapper bgded">
    <div id="pageintro" class="hoc clear">
    </div>

    <div style="margin-bottom: 280px;" class="wrapper row3">
        <main class="hoc container clear">
            <div class="center btmspace-50">
                <h2 class="heading">Заказ</h2>

                <h3 id="shop"></h3>

                <table id="productItem">
                </table>
                <center>
                    <select class="select" id="select" name="language" multiple>
                        <option disabled>Выбрать</option>
                    </select>
                     <input style="margin-top:20px" class="custom-btn btn-3" id="submit" type="submit" value="Отправить">
                </center>
            </div>

            <div class="clear"></div>
        </main>
    </div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>
        async function GetOrder(id) {
            const response = await fetch("/order/OrderTutor/" + id, {
                method: "GET",
                headers: { "Accept": "application/json" }
            });
            if (response.ok === true) {
                const order = await response.json();
                let table = document.getElementById("productItem");
                let shop = document.getElementById("shop");
                shop.append(order.shop.chain.name + " " + order.shop.address)
                order.products.forEach(product => {
                    const tr = document.createElement("tr");
                    tr.append(product.product.name + ": " + product.count);
                    table.append(tr);
                })
            }
        }

        async function GetVolontes() {
            const response = await fetch("https://localhost:7285/user/volonters", {
                method: "GET",
                headers: { "Accept": "application/json" }
            });
            if (response.ok === true) {
                const volonters = await response.json();
                let select = document.getElementById("select");
                volonters.forEach(volonter => {
                    const option = document.createElement("option");
                    option.append(volonter.fio);
                    option.setAttribute('value', volonter.id)
                    select.append(option);
                })

                SelectOpt();
            }
        }


        function SelectOpt() {
            $('.select').each(function () {
                const _this = $(this),
                    selectOption = _this.find('option'),
                    selectOptionLength = selectOption.length,
                    selectedOption = selectOption.filter(':selected'),
                    duration = 450; // длительность анимации

                _this.hide();
                _this.wrap('<div class="select"></div>');
                $('<div>', {
                    class: 'new-select',
                    text: _this.children('option:disabled').text()
                }).insertAfter(_this);

                const selectHead = _this.next('.new-select');
                $('<div>', {
                    class: 'new-select__list'
                }).insertAfter(selectHead);

                const selectList = selectHead.next('.new-select__list');
                for (let i = 1; i < selectOptionLength; i++) {
                    $('<div>', {
                        class: 'new-select__item',
                        html: $('<span>', {
                            text: selectOption.eq(i).text()
                        })
                    })
                        .attr('data-value', selectOption.eq(i).val())
                        .appendTo(selectList);
                }

                const selectItem = selectList.find('.new-select__item');
                selectList.slideUp(0);
                selectHead.on('click', function () {
                    if (!$(this).hasClass('on')) {
                        $(this).addClass('on');
                        selectList.slideDown(duration);

                        selectItem.on('click', function () {
                            let chooseItem = $(this).data('value');

                            $('select').val(chooseItem).attr('selected', 'selected');
                            selectHead.text($(this).find('span').text());

                            selectList.slideUp(duration);
                            selectHead.removeClass('on');
                        });

                    } else {
                        $(this).removeClass('on');
                        selectList.slideUp(duration);
                    }
                });
            });
        }

        async function Authorize() {
            const response = await fetch("https://localhost:7285/Account/Authorize", {
                method: "GET",
                headers: { "Accept": "application/json" }
            });
            if (response.ok === false) {
                window.location.href = '/index.html';
            }
            else
                Role();
        }
        async function SendVolonter(idOrder, idVolonter) {
            const response = await fetch("/order/sendVolonter", {
                method: "POST",
                headers: { "Accept": "application/json", "Content-Type": "application/json" },
                body: JSON.stringify({
                    idOrder: idOrder,
                    idVolonter: idVolonter
                })
            });
            if (response.ok === true) {
                window.location.href = '/shoporders.html';
            }
        }

        async function Role() {
            const response = await fetch("https://localhost:7285/Account/AuthorizeRole", {
                method: "GET",
                headers: { "Accept": "application/json" }
            });
            if (response.ok === true) {
                const resStr = await response.json();
                let exit = true
                resStr.forEach(str => {
                    if (str === "tutor") {
                        let a = document.getElementById("authorize");
                        a.setAttribute('href', '/Page/tutor-lk.html');
                        exit = false;
                    }
                })
                if (exit)
                    window.location.href = '/index.html';
            }

        }

        document.getElementById("submit").addEventListener("click", e => {
            e.preventDefault();
            var idVolonter = document.getElementById("select");
            SendVolonter(id, idVolonter.value);

        });

         Authorize();
         var id = window.location.href.split("?")[1].split("=")[1];
         GetOrder(id);
        GetVolontes();
    </script>

</body>
</html>
